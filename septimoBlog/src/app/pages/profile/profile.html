<section class="profile-container">
  <div class="profile-left">
    <div class="avatar">
      <img [src]="user.avatar || 'assets/Imagenes/user.png'" alt="Foto de {{ user.nombre }}" />
      <input type="file" #avatarInput class="avatar-input" accept="image/*" (change)="onAvatarSelected($event)" />
      <button type="button" class="icon-button avatar-edit" (click)="openAvatarPicker()" aria-label="Cambiar foto de perfil">
        <span class="material-icons">photo_camera</span>
      </button>
    </div>
    <div class="stats">
      <a class="stat-button" routerLink="/resenas">Reseñas ({{ reviewCount() }})</a>
      <a class="stat-button" routerLink="/mis-articulos">Artículos ({{ articleCount() }})</a>
      @if (user.rol === 'admin') {
        <a class="stat-button" routerLink="/resenas/crear">Añadir peliculas</a>
        <a class="stat-button admin-btn" routerLink="/admin">Panel de Administrador</a>
      }
      <button type="button" class="logout-button" (click)="logout()">Cerrar sesión</button>
    </div>
  </div>

  <div class="profile-right">
    <div class="nickname">{{ user.nombre }}</div>
    <div class="about-title">
      Sobre mí
      <button type="button" class="icon-button" (click)="toggleSobreMi()">
        <span class="material-icons">edit</span>
      </button>
    </div>

    @if (editingSobreMi) {
      <div class="edit-block">
        <textarea [(ngModel)]="sobreMiDraft"></textarea>
        <div class="edit-actions">
          <button type="button" (click)="saveSobreMi()">Guardar</button>
          <button type="button" (click)="toggleSobreMi()">Cancelar</button>
        </div>
      </div>
    } @else {
      <p class="description">
        {{ user.sobreMi || 'Este usuario aún no escribe su historia.' }}
      </p>
    }

    <div class="genres">
      <div class="genres-header">
        <p class="genres-title">Mis géneros favoritos</p>
        <button type="button" class="icon-button" (click)="toggleGeneros()">
          <span class="material-icons">edit</span>
        </button>
      </div>

      @if (editingGeneros) {
        <div class="edit-block">
          <div class="categories-grid">
            @for (category of allCategories(); track category._id) {
              <label class="category-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isCategorySelected(category._id)"
                  (change)="toggleCategory(category._id)">
                <span>{{ category.nombre }}</span>
              </label>
            }
          </div>
          @if (generosFeedback()) {
            <div class="feedback-banner" [class.error]="generosIsError()">{{ generosFeedback() }}</div>
          }
          <div class="edit-actions">
            <button type="button" class="save-btn" (click)="saveGeneros()" [disabled]="savingGeneros()">Guardar</button>
            <button type="button" class="cancel-btn" (click)="toggleGeneros()" [disabled]="savingGeneros()">Cancelar</button>
          </div>
        </div>
      } @else {
        <div class="genres-list">
          @for (genre of user.generosFav; track $index) {
            <span class="genre-pill">{{ getGenreName(genre) }}</span>
          }
          @if (user.generosFav.length === 0) {
            <p class="empty-genres">No has seleccionado géneros favoritos</p>
          }
        </div>
      }
    </div>
    
  </div>
</section>
